{"version":3,"sources":["utils.js"],"names":[],"mappings":"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","file":"utils-compiled.js","sourcesContent":["// Load modules\r\n\r\nvar Sntp = require('sntp');\r\nvar Boom = require('boom');\r\n\r\n\r\n// Declare internals\r\n\r\nvar internals = {};\r\n\r\n\r\nexports.version = function () {\r\n\r\n    return require('../package.json').version;\r\n};\r\n\r\n\r\nexports.limits = {\r\n    maxMatchLength: 4096            // Limit the length of uris and headers to avoid a DoS attack on string matching\r\n};\r\n\r\n\r\n// Extract host and port from request\r\n\r\n//                                            $1                            $2\r\ninternals.hostHeaderRegex = /^(?:(?:\\r\\n)?\\s)*((?:[^:]+)|(?:\\[[^\\]]+\\]))(?::(\\d+))?(?:(?:\\r\\n)?\\s)*$/;              // (IPv4, hostname)|(IPv6)\r\n\r\n\r\nexports.parseHost = function (req, hostHeaderName) {\r\n\r\n    hostHeaderName = (hostHeaderName ? hostHeaderName.toLowerCase() : 'host');\r\n    var hostHeader = req.headers[hostHeaderName];\r\n    if (!hostHeader) {\r\n        return null;\r\n    }\r\n\r\n    if (hostHeader.length > exports.limits.maxMatchLength) {\r\n        return null;\r\n    }\r\n\r\n    var hostParts = hostHeader.match(internals.hostHeaderRegex);\r\n    if (!hostParts) {\r\n        return null;\r\n    }\r\n\r\n    return {\r\n        name: hostParts[1],\r\n        port: (hostParts[2] ? hostParts[2] : (req.connection && req.connection.encrypted ? 443 : 80))\r\n    };\r\n};\r\n\r\n\r\n// Parse Content-Type header content\r\n\r\nexports.parseContentType = function (header) {\r\n\r\n    if (!header) {\r\n        return '';\r\n    }\r\n\r\n    return header.split(';')[0].trim().toLowerCase();\r\n};\r\n\r\n\r\n// Convert node's  to request configuration object\r\n\r\nexports.parseRequest = function (req, options) {\r\n\r\n    if (!req.headers) {\r\n        return req;\r\n    }\r\n\r\n    // Obtain host and port information\r\n\r\n    var host;\r\n    if (!options.host ||\r\n        !options.port) {\r\n\r\n        host = exports.parseHost(req, options.hostHeaderName);\r\n        if (!host) {\r\n            return new Error('Invalid Host header');\r\n        }\r\n    }\r\n\r\n    var request = {\r\n        method: req.method,\r\n        url: req.url,\r\n        host: options.host || host.name,\r\n        port: options.port || host.port,\r\n        authorization: req.headers.authorization,\r\n        contentType: req.headers['content-type'] || ''\r\n    };\r\n\r\n    return request;\r\n};\r\n\r\n\r\nexports.now = function (localtimeOffsetMsec) {\r\n\r\n    return Sntp.now() + (localtimeOffsetMsec || 0);\r\n};\r\n\r\n\r\nexports.nowSecs = function (localtimeOffsetMsec) {\r\n\r\n    return Math.floor(exports.now(localtimeOffsetMsec) / 1000);\r\n};\r\n\r\n\r\ninternals.authHeaderRegex = /^(\\w+)(?:\\s+(.*))?$/;                                      // Header: scheme[ something]\r\ninternals.attributeRegex = /^[ \\w\\!#\\$%&'\\(\\)\\*\\+,\\-\\.\\/\\:;<\\=>\\?@\\[\\]\\^`\\{\\|\\}~]+$/;   // !#$%&'()*+,-./:;<=>?@[]^_`{|}~ and space, a-z, A-Z, 0-9\r\n\r\n\r\n// Parse Hawk HTTP Authorization header\r\n\r\nexports.parseAuthorizationHeader = function (header, keys) {\r\n\r\n    keys = keys || ['id', 'ts', 'nonce', 'hash', 'ext', 'mac', 'app', 'dlg'];\r\n\r\n    if (!header) {\r\n        return Boom.unauthorized(null, 'Hawk');\r\n    }\r\n\r\n    if (header.length > exports.limits.maxMatchLength) {\r\n        return Boom.badRequest('Header length too long');\r\n    }\r\n\r\n    var headerParts = header.match(internals.authHeaderRegex);\r\n    if (!headerParts) {\r\n        return Boom.badRequest('Invalid header syntax');\r\n    }\r\n\r\n    var scheme = headerParts[1];\r\n    if (scheme.toLowerCase() !== 'hawk') {\r\n        return Boom.unauthorized(null, 'Hawk');\r\n    }\r\n\r\n    var attributesString = headerParts[2];\r\n    if (!attributesString) {\r\n        return Boom.badRequest('Invalid header syntax');\r\n    }\r\n\r\n    var attributes = {};\r\n    var errorMessage = '';\r\n    var verify = attributesString.replace(/(\\w+)=\"([^\"\\\\]*)\"\\s*(?:,\\s*|$)/g, function ($0, $1, $2) {\r\n\r\n        // Check valid attribute names\r\n\r\n        if (keys.indexOf($1) === -1) {\r\n            errorMessage = 'Unknown attribute: ' + $1;\r\n            return;\r\n        }\r\n\r\n        // Allowed attribute value characters\r\n\r\n        if ($2.match(internals.attributeRegex) === null) {\r\n            errorMessage = 'Bad attribute value: ' + $1;\r\n            return;\r\n        }\r\n\r\n        // Check for duplicates\r\n\r\n        if (attributes.hasOwnProperty($1)) {\r\n            errorMessage = 'Duplicate attribute: ' + $1;\r\n            return;\r\n        }\r\n\r\n        attributes[$1] = $2;\r\n        return '';\r\n    });\r\n\r\n    if (verify !== '') {\r\n        return Boom.badRequest(errorMessage || 'Bad header format');\r\n    }\r\n\r\n    return attributes;\r\n};\r\n\r\n\r\nexports.unauthorized = function (message, attributes) {\r\n\r\n    return Boom.unauthorized(message, 'Hawk', attributes);\r\n};\r\n\r\n"]}