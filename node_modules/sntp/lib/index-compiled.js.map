{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index-compiled.js","sourcesContent":["// Load modules\n\nvar Dgram = require('dgram');\nvar Dns = require('dns');\nvar Hoek = require('hoek');\n\n\n// Declare internals\n\nvar internals = {};\n\n\nexports.time = function (options, callback) {\n\n    if (arguments.length !== 2) {\n        callback = arguments[0];\n        options = {};\n    }\n\n    var settings = Hoek.clone(options);\n    settings.host = settings.host || 'pool.ntp.org';\n    settings.port = settings.port || 123;\n    settings.resolveReference = settings.resolveReference || false;\n\n    // Declare variables used by callback\n\n    var timeoutId = 0;\n    var sent = 0;\n\n    // Ensure callback is only called once\n\n    var finish = function (err, result) {\n\n        if (timeoutId) {\n            clearTimeout(timeoutId);\n            timeoutId = 0;\n        }\n\n        socket.removeAllListeners();\n        socket.once('error', internals.ignore);\n        socket.close();\n        return callback(err, result);\n    };\n\n    finish = Hoek.once(finish);\n\n    // Create UDP socket\n\n    var socket = Dgram.createSocket('udp4');\n\n    socket.once('error', function (err) {\n\n        return finish(err);\n    });\n\n    // Listen to incoming messages\n\n    socket.on('message', function (buffer, rinfo) {\n\n        var received = Date.now();\n\n        var message = new internals.NtpMessage(buffer);\n        if (!message.isValid) {\n            return finish(new Error('Invalid server response'), message);\n        }\n\n        if (message.originateTimestamp !== sent) {\n            return finish(new Error('Wrong originate timestamp'), message);\n        }\n\n        // Timestamp Name          ID   When Generated\n        // ------------------------------------------------------------\n        // Originate Timestamp     T1   time request sent by client\n        // Receive Timestamp       T2   time request received by server\n        // Transmit Timestamp      T3   time reply sent by server\n        // Destination Timestamp   T4   time reply received by client\n        //\n        // The roundtrip delay d and system clock offset t are defined as:\n        //\n        // d = (T4 - T1) - (T3 - T2)     t = ((T2 - T1) + (T3 - T4)) / 2\n\n        var T1 = message.originateTimestamp;\n        var T2 = message.receiveTimestamp;\n        var T3 = message.transmitTimestamp;\n        var T4 = received;\n\n        message.d = (T4 - T1) - (T3 - T2);\n        message.t = ((T2 - T1) + (T3 - T4)) / 2;\n        message.receivedLocally = received;\n\n        if (!settings.resolveReference ||\n            message.stratum !== 'secondary') {\n\n            return finish(null, message);\n        }\n\n        // Resolve reference IP address\n\n        Dns.reverse(message.referenceId, function (err, domains) {\n\n            if (/* $lab:coverage:off$ */ !err /* $lab:coverage:on$ */) {\n                message.referenceHost = domains[0];\n            }\n\n            return finish(null, message);\n        });\n    });\n\n    // Set timeout\n\n    if (settings.timeout) {\n        timeoutId = setTimeout(function () {\n\n            timeoutId = 0;\n            return finish(new Error('Timeout'));\n        }, settings.timeout);\n    }\n\n    // Construct NTP message\n\n    var message = new Buffer(48);\n    for (var i = 0; i < 48; i++) {                      // Zero message\n        message[i] = 0;\n    }\n\n    message[0] = (0 << 6) + (4 << 3) + (3 << 0)         // Set version number to 4 and Mode to 3 (client)\n    sent = Date.now();\n    internals.fromMsecs(sent, message, 40);               // Set transmit timestamp (returns as originate)\n\n    // Send NTP request\n\n    socket.send(message, 0, message.length, settings.port, settings.host, function (err, bytes) {\n\n        if (err ||\n            bytes !== 48) {\n\n            return finish(err || new Error('Could not send entire message'));\n        }\n    });\n};\n\n\ninternals.NtpMessage = function (buffer) {\n\n    this.isValid = false;\n\n    // Validate\n\n    if (buffer.length !== 48) {\n        return;\n    }\n\n    // Leap indicator\n\n    var li = (buffer[0] >> 6);\n    switch (li) {\n        case 0: this.leapIndicator = 'no-warning'; break;\n        case 1: this.leapIndicator = 'last-minute-61'; break;\n        case 2: this.leapIndicator = 'last-minute-59'; break;\n        case 3: this.leapIndicator = 'alarm'; break;\n    }\n\n    // Version\n\n    var vn = ((buffer[0] & 0x38) >> 3);\n    this.version = vn;\n\n    // Mode\n\n    var mode = (buffer[0] & 0x7);\n    switch (mode) {\n        case 1: this.mode = 'symmetric-active'; break;\n        case 2: this.mode = 'symmetric-passive'; break;\n        case 3: this.mode = 'client'; break;\n        case 4: this.mode = 'server'; break;\n        case 5: this.mode = 'broadcast'; break;\n        case 0:\n        case 6:\n        case 7: this.mode = 'reserved'; break;\n    }\n\n    // Stratum\n\n    var stratum = buffer[1];\n    if (stratum === 0) {\n        this.stratum = 'death';\n    }\n    else if (stratum === 1) {\n        this.stratum = 'primary';\n    }\n    else if (stratum <= 15) {\n        this.stratum = 'secondary';\n    }\n    else {\n        this.stratum = 'reserved';\n    }\n\n    // Poll interval (msec)\n\n    this.pollInterval = Math.round(Math.pow(2, buffer[2])) * 1000;\n\n    // Precision (msecs)\n\n    this.precision = Math.pow(2, buffer[3]) * 1000;\n\n    // Root delay (msecs)\n\n    var rootDelay = 256 * (256 * (256 * buffer[4] + buffer[5]) + buffer[6]) + buffer[7];\n    this.rootDelay = 1000 * (rootDelay / 0x10000);\n\n    // Root dispersion (msecs)\n\n    this.rootDispersion = ((buffer[8] << 8) + buffer[9] + ((buffer[10] << 8) + buffer[11]) / Math.pow(2, 16)) * 1000;\n\n    // Reference identifier\n\n    this.referenceId = '';\n    switch (this.stratum) {\n        case 'death':\n        case 'primary':\n            this.referenceId = String.fromCharCode(buffer[12]) + String.fromCharCode(buffer[13]) + String.fromCharCode(buffer[14]) + String.fromCharCode(buffer[15]);\n            break;\n        case 'secondary':\n            this.referenceId = '' + buffer[12] + '.' + buffer[13] + '.' + buffer[14] + '.' + buffer[15];\n            break;\n    }\n\n    // Reference timestamp\n\n    this.referenceTimestamp = internals.toMsecs(buffer, 16);\n\n    // Originate timestamp\n\n    this.originateTimestamp = internals.toMsecs(buffer, 24);\n\n    // Receive timestamp\n\n    this.receiveTimestamp = internals.toMsecs(buffer, 32);\n\n    // Transmit timestamp\n\n    this.transmitTimestamp = internals.toMsecs(buffer, 40);\n\n    // Validate\n\n    if (this.version === 4 &&\n        this.stratum !== 'reserved' &&\n        this.mode === 'server' &&\n        this.originateTimestamp &&\n        this.receiveTimestamp &&\n        this.transmitTimestamp) {\n\n        this.isValid = true;\n    }\n\n    return this;\n};\n\n\ninternals.toMsecs = function (buffer, offset) {\n\n    var seconds = 0;\n    var fraction = 0;\n\n    for (var i = 0; i < 4; ++i) {\n        seconds = (seconds * 256) + buffer[offset + i];\n    }\n\n    for (i = 4; i < 8; ++i) {\n        fraction = (fraction * 256) + buffer[offset + i];\n    }\n\n    return ((seconds - 2208988800 + (fraction / Math.pow(2, 32))) * 1000);\n};\n\n\ninternals.fromMsecs = function (ts, buffer, offset) {\n\n    var seconds = Math.floor(ts / 1000) + 2208988800;\n    var fraction = Math.round((ts % 1000) / 1000 * Math.pow(2, 32));\n\n    buffer[offset + 0] = (seconds & 0xFF000000) >> 24;\n    buffer[offset + 1] = (seconds & 0x00FF0000) >> 16;\n    buffer[offset + 2] = (seconds & 0x0000FF00) >> 8;\n    buffer[offset + 3] = (seconds & 0x000000FF);\n\n    buffer[offset + 4] = (fraction & 0xFF000000) >> 24;\n    buffer[offset + 5] = (fraction & 0x00FF0000) >> 16;\n    buffer[offset + 6] = (fraction & 0x0000FF00) >> 8;\n    buffer[offset + 7] = (fraction & 0x000000FF);\n};\n\n\n// Offset singleton\n\ninternals.last = {\n    offset: 0,\n    expires: 0,\n    host: '',\n    port: 0\n};\n\n\nexports.offset = function (options, callback) {\n\n    if (arguments.length !== 2) {\n        callback = arguments[0];\n        options = {};\n    }\n\n    var now = Date.now();\n    var clockSyncRefresh = options.clockSyncRefresh || 24 * 60 * 60 * 1000;                    // Daily\n\n    if (internals.last.offset &&\n        internals.last.host === options.host &&\n        internals.last.port === options.port &&\n        now < internals.last.expires) {\n\n        process.nextTick(function () {\n\n            callback(null, internals.last.offset);\n        });\n\n        return;\n    }\n\n    exports.time(options, function (err, time) {\n\n        if (err) {\n            return callback(err, 0);\n        }\n\n        internals.last = {\n            offset: Math.round(time.t),\n            expires: now + clockSyncRefresh,\n            host: options.host,\n            port: options.port\n        };\n\n        return callback(null, internals.last.offset);\n    });\n};\n\n\n// Now singleton\n\ninternals.now = {\n    intervalId: 0\n};\n\n\nexports.start = function (options, callback) {\n\n    if (arguments.length !== 2) {\n        callback = arguments[0];\n        options = {};\n    }\n\n    if (internals.now.intervalId) {\n        process.nextTick(function () {\n\n            callback();\n        });\n\n        return;\n    }\n\n    exports.offset(options, function (err, offset) {\n\n        internals.now.intervalId = setInterval(function () {\n\n            exports.offset(options, function () { });\n        }, options.clockSyncRefresh || 24 * 60 * 60 * 1000);                                // Daily\n\n        return callback();\n    });\n};\n\n\nexports.stop = function () {\n\n    if (!internals.now.intervalId) {\n        return;\n    }\n\n    clearInterval(internals.now.intervalId);\n    internals.now.intervalId = 0;\n};\n\n\nexports.isLive = function () {\n\n    return !!internals.now.intervalId;\n};\n\n\nexports.now = function () {\n\n    var now = Date.now();\n    if (!exports.isLive() ||\n        now >= internals.last.expires) {\n\n        return now;\n    }\n\n    return now + internals.last.offset;\n};\n\n\ninternals.ignore = function () {\n\n};\n"]}